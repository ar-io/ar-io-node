FROM debian:bookworm-slim

# Install required packages and ClickHouse
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    jq \
    bc \
    sqlite3 \
    unzip \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/* \
    && curl -LO https://github.com/ClickHouse/ClickHouse/releases/download/v24.11.1.2557-stable/clickhouse-common-static-24.11.1.2557-amd64.tgz \
    && tar -xzf clickhouse-common-static-24.11.1.2557-amd64.tgz \
    && mv ./clickhouse-common-static-24.11.1.2557/usr/bin/clickhouse usr/local/bin/ \
    && rm -r clickhouse-common-static-24.11.1.2557-amd64.tgz ./clickhouse-common-static-24.11.1.2557

# Install DuckDB
RUN curl -LO https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip \
    && unzip duckdb_cli-linux-amd64.zip \
    && mv duckdb /usr/local/bin/ \
    && chmod +x /usr/local/bin/duckdb \
    && rm duckdb_cli-linux-amd64.zip

# Install PyIceberg for optional Iceberg metadata generation
# Use virtual environment to avoid system package conflicts
RUN python3 -m venv /app/venv && \
    /app/venv/bin/pip install --no-cache-dir pyiceberg[duckdb,pyarrow]==0.8.1

# Create necessary directories
WORKDIR /app
RUN mkdir -p data/parquet/imported

# Copy the necessary scripts and libraries
COPY src/database/clickhouse/schema.sql /app/src/database/clickhouse/schema.sql
COPY src/database/duckdb/schema.sql /app/src/database/duckdb/schema.sql
COPY scripts/clickhouse-auto-import /app/scripts/
COPY scripts/clickhouse-import /app/scripts/
COPY scripts/parquet-export /app/scripts/
COPY scripts/generate-iceberg-metadata /app/scripts/
COPY scripts/lib /app/scripts/lib/

# Make scripts executable
RUN chmod +x /app/scripts/clickhouse-auto-import /app/scripts/clickhouse-import /app/scripts/parquet-export /app/scripts/generate-iceberg-metadata

# Environment variables
ENV ADMIN_API_KEY=""
ENV PATH="/app/venv/bin:$PATH"

# Run the auto-import script
CMD ["/app/scripts/clickhouse-auto-import"]
