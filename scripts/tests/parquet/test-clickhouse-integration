#!/usr/bin/env bash

# Test script for ClickHouse integration with parquet-export

# Load common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../lib/common.sh"

echo "Testing ClickHouse Integration with Parquet Export"
echo "=================================================="
echo

# Load environment and ClickHouse configuration
load_env
load_clickhouse_config

# Configuration
TEST_DIR="data/test-clickhouse-integration"
START_HEIGHT=1718100
END_HEIGHT=1718102
PARTITION_SIZE=5

echo "Configuration:"
echo "  Test directory: $TEST_DIR"
echo "  Height range: $START_HEIGHT to $END_HEIGHT"
echo "  Partition size: $PARTITION_SIZE"
echo "  ClickHouse: $CLICKHOUSE_HOST:$CLICKHOUSE_PORT"
echo

# Clean up previous test
echo "Cleaning up previous test data..."
rm -rf "$TEST_DIR"

# Test 1: Export with ClickHouse integration
echo "Test 1: Running parquet-export with ClickHouse integration..."
./scripts/parquet-export \
    --startHeight "$START_HEIGHT" \
    --endHeight "$END_HEIGHT" \
    --heightPartitionSize "$PARTITION_SIZE" \
    --outputDir "$TEST_DIR" \
    --includeL2Transactions \
    --includeL2Tags \
    --enableClickhouse \
    --clickhouseHost "$CLICKHOUSE_HOST" \
    --clickhousePort "$CLICKHOUSE_PORT" \
    --clickhouseUser "$CLICKHOUSE_USER" \
    --clickhousePassword "$CLICKHOUSE_PASSWORD" \
    --verifyCount

if [ $? -eq 0 ]; then
    echo "✓ Export and ClickHouse import completed successfully"
else
    echo "✗ Export or import failed"
    exit 1
fi

echo
echo "Test 2: Verifying Parquet files were created..."
if [ -d "$TEST_DIR/blocks/data" ] && [ -d "$TEST_DIR/transactions/data" ] && [ -d "$TEST_DIR/tags/data" ]; then
    echo "✓ Parquet directory structure created"
    
    # Count files
    BLOCK_FILES=$(find "$TEST_DIR/blocks/data" -name "*.parquet" | wc -l)
    TX_FILES=$(find "$TEST_DIR/transactions/data" -name "*.parquet" | wc -l)
    TAG_FILES=$(find "$TEST_DIR/tags/data" -name "*.parquet" | wc -l)
    
    echo "  Found $BLOCK_FILES block files, $TX_FILES transaction files, $TAG_FILES tag files"
else
    echo "✗ Expected directory structure not found"
    exit 1
fi

echo
echo "Test 3: Verifying data in ClickHouse..."
if command -v clickhouse >/dev/null 2>&1; then
    # Check block count
    CLICKHOUSE_BLOCKS=$(clickhouse client \
        --host "$CLICKHOUSE_HOST" \
        --port "$CLICKHOUSE_PORT" \
        --user "$CLICKHOUSE_USER" \
        --password "$CLICKHOUSE_PASSWORD" \
        --query "SELECT COUNT(*) FROM blocks WHERE height >= $START_HEIGHT AND height <= $END_HEIGHT" 2>/dev/null || echo "0")
    
    # Check transaction count
    CLICKHOUSE_TXS=$(clickhouse client \
        --host "$CLICKHOUSE_HOST" \
        --port "$CLICKHOUSE_PORT" \
        --user "$CLICKHOUSE_USER" \
        --password "$CLICKHOUSE_PASSWORD" \
        --query "SELECT COUNT(*) FROM transactions WHERE height >= $START_HEIGHT AND height <= $END_HEIGHT" 2>/dev/null || echo "0")
    
    echo "  ClickHouse blocks: $CLICKHOUSE_BLOCKS"
    echo "  ClickHouse transactions: $CLICKHOUSE_TXS"
    
    if [ "$CLICKHOUSE_BLOCKS" -gt 0 ] && [ "$CLICKHOUSE_TXS" -gt 0 ]; then
        echo "✓ Data successfully imported to ClickHouse"
    else
        echo "⚠ No data found in ClickHouse (may not be connected)"
    fi
else
    echo "⚠ ClickHouse client not installed, skipping verification"
fi

echo
echo "Test 4: Testing resume capability..."
# Run again with same parameters - should detect already completed work
echo "Running export again (should resume from checkpoint)..."
./scripts/parquet-export \
    --startHeight "$START_HEIGHT" \
    --endHeight "$END_HEIGHT" \
    --heightPartitionSize "$PARTITION_SIZE" \
    --outputDir "$TEST_DIR" \
    --includeL2Transactions \
    --includeL2Tags \
    --enableClickhouse \
    --clickhouseHost "$CLICKHOUSE_HOST" \
    --clickhousePort "$CLICKHOUSE_PORT" \
    --clickhouseUser "$CLICKHOUSE_USER" \
    --clickhousePassword "$CLICKHOUSE_PASSWORD" 2>&1 | grep -q "already completed"

if [ $? -eq 0 ]; then
    echo "✓ Resume capability working (detected previous export)"
else
    echo "⚠ Resume check inconclusive"
fi

echo
echo "All tests completed!"
echo
echo "Summary:"
echo "  - Parquet export with ClickHouse integration: ✓"
echo "  - Iceberg-compatible directory structure: ✓"
echo "  - Data verification: ✓"
echo "  - Resume capability: ✓"