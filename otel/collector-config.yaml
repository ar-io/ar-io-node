# OpenTelemetry Collector Configuration
# This collector implements tail-based sampling to reduce telemetry costs
# while maintaining complete visibility into errors and performance issues.

receivers:
  # OTLP receivers for traces from ar-io-node
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  # Batch processor to improve network efficiency
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Tail sampling - makes sampling decisions after traces complete
  # This allows us to see the full trace before deciding to keep/drop it
  tail_sampling:
    # Wait 10 seconds after trace starts before making decision
    # This ensures the entire trace has been collected
    decision_wait: 10s

    # Number of traces to keep in memory during decision period
    num_traces: 100000

    # Expected new traces per second (helps with memory management)
    expected_new_traces_per_sec: 100

    policies:
      # Policy 1: Always keep traces with errors (100% sampling)
      # Catches HTTP 5xx responses and application errors
      - name: error-policy
        type: status_code
        status_code:
          status_codes:
            - ERROR

      # Policy 2: Always keep slow traces (100% sampling)
      # Default threshold: 2000ms (configurable via OTEL_TAIL_SAMPLING_SLOW_THRESHOLD_MS)
      - name: latency-policy
        type: latency
        latency:
          threshold_ms: ${env:OTEL_TAIL_SAMPLING_SLOW_THRESHOLD_MS}

      # Policy 3: Probabilistic sampling of successful, fast traces
      # Default: 1% (configurable via OTEL_TAIL_SAMPLING_SUCCESS_RATE)
      # This provides baseline visibility into normal operations
      - name: baseline-success-policy
        type: probabilistic
        probabilistic:
          sampling_percentage: ${env:OTEL_TAIL_SAMPLING_SUCCESS_RATE}

exporters:
  # Export to final telemetry destination (e.g., Honeycomb, Grafana Cloud, etc.)
  # Using otlphttp exporter for compatibility with standard OTEL env vars
  otlphttp:
    endpoint: ${env:OTEL_COLLECTOR_DESTINATION_ENDPOINT}
    # Headers are set via OTEL_EXPORTER_OTLP_HEADERS environment variable
    # which the collector reads automatically in format: "key1=value1,key2=value2"
    # Example: "x-honeycomb-team=abc123,x-custom-header=value"
    #
    # For file-based headers, use OTEL_EXPORTER_OTLP_HEADERS_FILE which the
    # collector also reads automatically
    compression: gzip
    timeout: 30s

  # Debug exporter for troubleshooting (disabled in production)
  # Uncomment to see sampled traces in collector logs
  # debug:
  #   verbosity: detailed

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [tail_sampling, batch]
      exporters: [otlphttp]
      # Add debug exporter for troubleshooting: exporters: [otlphttp, debug]
